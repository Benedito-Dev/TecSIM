import * as Notifications from 'expo-notifications';
import * as Device from 'expo-device';
import messaging from '@react-native-firebase/messaging';

// Fun√ß√£o √∫nica para inicializar notifica√ß√µes
export async function setupNotifications() {
  if (!Device.isDevice) {
    console.log('Push notifications funcionam apenas em dispositivo f√≠sico!');
    return null;
  }

  // Pedir permiss√£o
  const authStatus = await Notifications.requestPermissionsAsync();
  const granted =
    authStatus.status === 'granted' || authStatus.status === 'provisional';

  if (!granted) {
    console.log('Permiss√£o para notifica√ß√µes negada!');
    return null;
  }

  // Pegar token FCM
  const fcmToken = await messaging().getToken();
  console.log('FCM Token:', fcmToken);

  // Listener para mensagens em foreground
  messaging().onMessage(async remoteMessage => {
    console.log('Mensagem recebida:', remoteMessage);
    Notifications.presentNotificationAsync({
      title: remoteMessage.notification?.title,
      body: remoteMessage.notification?.body,
    });
  });

  return fcmToken;
}

// Fun√ß√£o de teste: envia notifica√ß√£o local
export async function testWaterNotification() {
  try {
    await Notifications.scheduleNotificationAsync({
      content: {
        title: 'üíß Hora de beber √°gua!',
        body: 'Esta √© uma notifica√ß√£o de teste.',
      },
      trigger: null, // dispara imediatamente
    });
    return true;
  } catch (error) {
    console.error('Erro ao enviar notifica√ß√£o de teste:', error);
    return false;
  }
}
