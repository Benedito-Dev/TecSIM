const CompositionService = require('../../services/openEHR/compositionServices');

class CompositionController {
  constructor() {
    console.log('üîÑ Inicializando CompositionController...');
    
    try {
      this.compositionService = new CompositionService();
      console.log('‚úÖ CompositionService carregado com sucesso');
    } catch (error) {
      console.error('‚ùå Erro ao carregar CompositionService:', error);
    }
    
    // Bind dos m√©todos para manter o contexto do 'this'
    this.createComposition = this.createComposition.bind(this);
    this.getPatientCompositions = this.getPatientCompositions.bind(this);
    this.getComposition = this.getComposition.bind(this);
    this.updateComposition = this.updateComposition.bind(this);
    this.deleteComposition = this.deleteComposition.bind(this);
    this.getPatientClinicalSummary = this.getPatientClinicalSummary.bind(this);
    this.healthCheck = this.healthCheck.bind(this);
  }

  // POST /ehr/compositions
  async createComposition(req, res) {
    try {
      console.log('üìù Criando composi√ß√£o:', req.body); // Debug
      
      const compositionData = {
        ...req.body,
        author: req.user?.id || 'system'
      };

      const composition = await this.compositionService.createComposition(compositionData);

      res.status(201).json({
        success: true,
        data: composition,
        message: 'Composi√ß√£o criada com sucesso'
      });

    } catch (error) {
      console.error('‚ùå Erro ao criar composi√ß√£o:', error);
      res.status(400).json({
        success: false,
        error: error.message
      });
    }
  }

  // GET /ehr/compositions/patient/:pacienteId
  async getPatientCompositions(req, res) {
    try {
      const { pacienteId } = req.params;
      const { 
        templateId, 
        limit = 50, 
        offset = 0,
        status = 'active'
      } = req.query;

      console.log('üîç Buscando composi√ß√µes do paciente:', pacienteId); // Debug

      const compositions = await this.compositionService.getPatientCompositions(
        parseInt(pacienteId), 
        { 
          templateId, 
          limit: parseInt(limit), 
          offset: parseInt(offset),
          status 
        }
      );

      res.json({
        success: true,
        data: compositions,
        count: compositions.length
      });

    } catch (error) {
      console.error('‚ùå Erro ao buscar composi√ß√µes:', error);
      res.status(500).json({
        success: false,
        error: error.message
      });
    }
  }

  // GET /ehr/compositions/:compositionId
  async getComposition(req, res) {
    try {
      const { compositionId } = req.params;
      console.log('üîç Buscando composi√ß√£o:', compositionId); // Debug

      const composition = await this.compositionService.getComposition(compositionId);

      res.json({
        success: true,
        data: composition
      });

    } catch (error) {
      console.error('‚ùå Erro ao buscar composi√ß√£o:', error);
      if (error.message === 'Composi√ß√£o n√£o encontrada') {
        return res.status(404).json({
          success: false,
          error: error.message
        });
      }
      res.status(500).json({
        success: false,
        error: error.message
      });
    }
  }

  // PUT /ehr/compositions/:compositionId
  async updateComposition(req, res) {
    try {
      const { compositionId } = req.params;
      const updateData = {
        ...req.body,
        author: req.user?.id || 'system'
      };

      console.log('‚úèÔ∏è Atualizando composi√ß√£o:', compositionId); // Debug

      const updatedComposition = await this.compositionService.updateComposition(
        compositionId, 
        updateData
      );

      res.json({
        success: true,
        data: updatedComposition,
        message: 'Composi√ß√£o atualizada com sucesso'
      });

    } catch (error) {
      console.error('‚ùå Erro ao atualizar composi√ß√£o:', error);
      if (error.message === 'Composi√ß√£o n√£o encontrada') {
        return res.status(404).json({
          success: false,
          error: error.message
        });
      }
      res.status(400).json({
        success: false,
        error: error.message
      });
    }
  }

  // DELETE /ehr/compositions/:compositionId
  async deleteComposition(req, res) {
    try {
      const { compositionId } = req.params;
      console.log('üóëÔ∏è Deletando composi√ß√£o:', compositionId); // Debug

      await this.compositionService.deleteComposition(compositionId);

      res.json({
        success: true,
        message: 'Composi√ß√£o removida com sucesso'
      });

    } catch (error) {
      console.error('‚ùå Erro ao deletar composi√ß√£o:', error);
      if (error.message === 'Composi√ß√£o n√£o encontrada') {
        return res.status(404).json({
          success: false,
          error: error.message
        });
      }
      res.status(500).json({
        success: false,
        error: error.message
      });
    }
  }

  // GET /ehr/patient/:pacienteId/summary
  async getPatientClinicalSummary(req, res) {
    try {
      const { pacienteId } = req.params;
      console.log('üìä Gerando resumo cl√≠nico para paciente:', pacienteId); // Debug

      const summary = await this.compositionService.getPatientClinicalSummary(parseInt(pacienteId));

      res.json({
        success: true,
        data: summary
      });

    } catch (error) {
      console.error('‚ùå Erro ao gerar resumo cl√≠nico:', error);
      res.status(500).json({
        success: false,
        error: error.message
      });
    }
  }

  // Health check
  async healthCheck(req, res) {
    try {
      console.log('‚ù§Ô∏è Health check openEHR'); // Debug
      res.json({
        success: true,
        message: 'Servi√ßo openEHR est√° funcionando corretamente',
        timestamp: new Date().toISOString()
      });
    } catch (error) {
      console.error('‚ùå Erro no health check:', error);
      res.status(500).json({
        success: false,
        error: 'Servi√ßo openEHR com problemas: ' + error.message
      });
    }
  }
}

module.exports = CompositionController;