const CompositionRepository = require('../../repository/openEHR/CompositionRepository');
const PacienteService = require('../pacientesService');

class CompositionService {
  constructor() {
    this.compositionRepo = new CompositionRepository();
  }

  async createComposition(compositionData) {
    try {
      const paciente = await PacienteService.getById(compositionData.paciente_id);
      if (!paciente) {
        throw new Error('Paciente n√£o encontrado');
      }

      console.log('‚úÖ Paciente validado:', paciente.nome);

      const validationErrors = this.validateCompositionData(compositionData);
      if (validationErrors.length > 0) {
        throw new Error(`Dados inv√°lidos: ${validationErrors.join(', ')}`);
      }

      await this.validateTemplateData(compositionData.template_id, compositionData.composition_data);

      const composition = await this.compositionRepo.create(compositionData);
      return composition;

    } catch (error) {
      throw new Error(`Erro ao criar composi√ß√£o: ${error.message}`);
    }
  }

  async getComposition(compositionId) {
    try {
      console.log('üîç Service - Buscando composi√ß√£o:', compositionId);
      
      const composition = await this.compositionRepo.findById(compositionId);
      if (!composition) {
        throw new Error('Composi√ß√£o n√£o encontrada');
      }
      
      console.log('‚úÖ Composi√ß√£o encontrada:', composition.composition_id);
      return composition;
      
    } catch (error) {
      console.error('‚ùå Erro no Service - getComposition:', error);
      throw new Error(`Erro ao buscar composi√ß√£o: ${error.message}`);
    }
  }

  async getPatientCompositions(pacienteId, filters = {}) {
    try {
      await PacienteService.getById(pacienteId);
      return await this.compositionRepo.findByPatientId(pacienteId, filters);
    } catch (error) {
      throw new Error(`Erro ao buscar composi√ß√µes do paciente: ${error.message}`);
    }
  }

  async updateComposition(compositionId, updateData) {
    try {
      const existing = await this.getComposition(compositionId);
      
      const validationErrors = this.validateCompositionData(updateData, true);
      if (validationErrors.length > 0) {
        throw new Error(`Dados de atualiza√ß√£o inv√°lidos: ${validationErrors.join(', ')}`);
      }

      return await this.compositionRepo.update(compositionId, updateData);

    } catch (error) {
      throw new Error(`Erro ao atualizar composi√ß√£o: ${error.message}`);
    }
  }

  async deleteComposition(compositionId) {
    try {
      await this.getComposition(compositionId);
      return await this.compositionRepo.delete(compositionId);
    } catch (error) {
      throw new Error(`Erro ao deletar composi√ß√£o: ${error.message}`);
    }
  }

  async getPatientClinicalSummary(pacienteId) {
    try {
      await PacienteService.getById(pacienteId);

      const [compositions, summary] = await Promise.all([
        this.compositionRepo.findByPatientId(pacienteId, { limit: 10 }),
        this.compositionRepo.getPatientClinicalSummary(pacienteId)
      ]);

      return {
        paciente_id: pacienteId,
        total_compositions: compositions.length,
        clinical_summary: summary,
        recent_compositions: compositions,
        last_update: compositions[0]?.created_at || null
      };

    } catch (error) {
      throw new Error(`Erro ao gerar resumo cl√≠nico: ${error.message}`);
    }
  }

  validateCompositionData(compositionData, isUpdate = false) {
    const errors = [];

    if (!isUpdate) {
      if (!compositionData.paciente_id) {
        errors.push('paciente_id √© obrigat√≥rio');
      }
      if (!compositionData.template_id) {
        errors.push('template_id √© obrigat√≥rio');
      }
    }

    if (compositionData.composition_data) {
      if (typeof compositionData.composition_data !== 'object') {
        errors.push('composition_data deve ser um objeto');
      }
    }

    return errors;
  }

  async validateTemplateData(templateId, compositionData) {
    switch (templateId) {
      case 'BLOOD_PRESSURE_V1':
        if (!compositionData.systolic || !compositionData.diastolic) {
          throw new Error('Press√£o sist√≥lica e diast√≥lica s√£o obrigat√≥rias');
        }
        break;
      case 'HEART_RATE_V1':
        if (!compositionData.rate) {
          throw new Error('Frequ√™ncia card√≠aca √© obrigat√≥ria');
        }
        break;
      case 'TEMPERATURE_V1':
        if (!compositionData.value) {
          throw new Error('Temperatura √© obrigat√≥ria');
        }
        break;
      case 'SYMPTOMS_V1':
        if (!compositionData.symptoms || compositionData.symptoms.length === 0) {
          throw new Error('Pelo menos um sintoma √© obrigat√≥rio');
        }
        break;
      case 'MEDICATION_V1':
        if (!compositionData.name) {
          throw new Error('Nome da medica√ß√£o √© obrigat√≥rio');
        }
        break;
    }
  }
}

module.exports = CompositionService;